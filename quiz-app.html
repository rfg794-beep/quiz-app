<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Â£∞„ÅßÁ≠î„Åà„Çã„ÇØ„Ç§„Ç∫</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=M+PLUS+Rounded+1c:wght@400;800&display=swap');

  :root {
    --bg: #0f0e17;
    --surface: #1a1828;
    --accent: #ff6b35;
    --accent2: #ffd700;
    --text: #fffffe;
    --muted: #a7a9be;
    --correct: #2cb67d;
    --wrong: #e53170;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Zen Maru Gothic', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow: hidden;
    position: relative;
  }

  /* Animated background blobs */
  .blob {
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.15;
    animation: blobFloat 8s ease-in-out infinite alternate;
    pointer-events: none;
  }
  .blob1 { width: 300px; height: 300px; background: var(--accent); top: -100px; left: -100px; animation-delay: 0s; }
  .blob2 { width: 250px; height: 250px; background: #7b2fff; bottom: -80px; right: -80px; animation-delay: 3s; }
  .blob3 { width: 200px; height: 200px; background: var(--accent2); top: 50%; left: 50%; transform: translate(-50%,-50%); animation-delay: 1.5s; }

  @keyframes blobFloat {
    from { transform: scale(1) translate(0,0); }
    to { transform: scale(1.2) translate(20px, 20px); }
  }

  .container {
    width: 100%;
    max-width: 480px;
    position: relative;
    z-index: 1;
  }

  h1 {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-weight: 800;
    font-size: 1.8rem;
    text-align: center;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .subtitle {
    text-align: center;
    color: var(--muted);
    font-size: 0.85rem;
    margin-bottom: 32px;
  }

  .card {
    background: var(--surface);
    border-radius: 24px;
    padding: 28px 24px;
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    margin-bottom: 20px;
  }

  #status-area {
    text-align: center;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 8px;
  }

  #status-text {
    font-size: 0.9rem;
    color: var(--muted);
  }

  #question-area {
    display: none;
    text-align: center;
  }

  #question-label {
    font-size: 0.75rem;
    color: var(--accent);
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  #question-text {
    font-size: 1.2rem;
    font-weight: 700;
    line-height: 1.6;
    color: var(--text);
    min-height: 80px;
  }

  #answer-area {
    display: none;
    margin-top: 20px;
    padding: 16px;
    background: rgba(255,255,255,0.04);
    border-radius: 14px;
    text-align: center;
  }

  #answer-label {
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  #answer-text {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent2);
  }

  /* Mic button */
  .mic-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 24px;
  }

  #mic-btn {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, var(--accent), #ff8c42);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 30px rgba(255,107,53,0.4);
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
  }

  #mic-btn:hover { transform: scale(1.05); }
  #mic-btn:active { transform: scale(0.95); }

  #mic-btn.listening {
    animation: pulse 1.2s ease-in-out infinite;
    background: linear-gradient(135deg, var(--wrong), #ff6b9d);
    box-shadow: 0 8px 40px rgba(229,49,112,0.5);
  }

  #mic-btn.loading {
    background: linear-gradient(135deg, #555, #777);
    box-shadow: none;
    cursor: not-allowed;
  }

  @keyframes pulse {
    0%, 100% { box-shadow: 0 8px 30px rgba(229,49,112,0.4); transform: scale(1); }
    50% { box-shadow: 0 8px 50px rgba(229,49,112,0.7); transform: scale(1.08); }
  }

  #mic-btn svg { width: 32px; height: 32px; fill: white; }

  #mic-label {
    text-align: center;
    font-size: 0.8rem;
    color: var(--muted);
    margin-top: 10px;
  }

  /* Transcript bubble */
  #transcript-box {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px 16px;
    margin-top: 16px;
    font-size: 0.9rem;
    color: var(--muted);
    min-height: 40px;
    text-align: center;
    display: none;
    border: 1px solid rgba(255,255,255,0.08);
  }

  /* Result flash */
  .result-flash {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5rem;
    pointer-events: none;
    z-index: 100;
    animation: flashAnim 0.8s ease forwards;
  }

  @keyframes flashAnim {
    0% { opacity: 1; transform: scale(0.5); }
    50% { opacity: 1; transform: scale(1.2); }
    100% { opacity: 0; transform: scale(1.5); }
  }

  /* Score */
  #score-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 16px;
    background: rgba(255,255,255,0.04);
    border-radius: 12px;
    margin-bottom: 16px;
    font-size: 0.85rem;
  }

  #score-bar span { color: var(--muted); }
  #score-bar strong { color: var(--accent2); font-size: 1.1rem; }

  .loading-dots span {
    display: inline-block;
    animation: dotBounce 1.2s ease-in-out infinite;
    color: var(--accent);
    font-size: 1.5rem;
  }
  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes dotBounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
  }

  #api-key-area {
    margin-bottom: 16px;
  }

  #api-key-area label {
    font-size: 0.8rem;
    color: var(--muted);
    display: block;
    margin-bottom: 6px;
  }

  #api-key-input {
    width: 100%;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--text);
    font-family: monospace;
    font-size: 0.85rem;
    outline: none;
  }

  #api-key-input:focus {
    border-color: var(--accent);
  }

  .hint {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 6px;
    opacity: 0.7;
  }
</style>
</head>
<body>
<div class="blob blob1"></div>
<div class="blob blob2"></div>
<div class="blob blob3"></div>

<div class="container">
  <h1>üé§ Â£∞„Åß„ÇØ„Ç§„Ç∫ÔºÅ</h1>
  <p class="subtitle">Â∞èÂ≠¶Áîü„É¨„Éô„É´„Å†„Åë„Å©Â§ß‰∫∫„ÇÇ„Å≤„Å£„Åã„Åã„Çã„ÇàüëÄ</p>

  <div class="card">
    <div id="api-key-area">
      <label>Anthropic API„Ç≠„ÉºÔºàClaudeÔºâ</label>
      <input type="password" id="api-key-input" placeholder="sk-ant-..." />
      <p class="hint">‚Äª„Ç≠„Éº„ÅØ„Éñ„É©„Ç¶„Ç∂„ÅÆ„É°„É¢„É™„Å´„ÅÆ„Åø‰øùÂ≠ò„Åï„Çå„ÄÅÂ§ñÈÉ®ÈÄÅ‰ø°„Åï„Çå„Åæ„Åõ„ÇìÔºàClaude API„Å∏„ÅÆÂïèÈ°åÁîüÊàê„É™„ÇØ„Ç®„Çπ„Éà„Å´„ÅÆ„Åø‰ΩøÁî®Ôºâ</p>
    </div>

    <div id="score-bar" style="display:none">
      <span>Ê≠£Ëß£Êï∞</span>
      <strong id="score-display">0 / 0</strong>
    </div>

    <div id="status-area">
      <p id="status-text">„ÄåÂïèÈ°åÂá∫„Åó„Å¶„Äç„Å®Ë©±„Åó„Åã„Åë„Å¶„Åø„Çà„ÅÜÔºÅ</p>
    </div>

    <div id="question-area">
      <div id="question-label">Q U E S T I O N</div>
      <div id="question-text"></div>
      <div id="answer-area">
        <div id="answer-label">„Åì„Åü„Åà</div>
        <div id="answer-text"></div>
      </div>
    </div>

    <div id="transcript-box"></div>

    <div class="mic-wrapper">
      <button id="mic-btn" title="„Éû„Ç§„ÇØ„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë©±„Åô">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 1a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V5a4 4 0 0 1 4-4zm-1 18.93V22h2v-2.07A8 8 0 0 0 20 12h-2a6 6 0 0 1-12 0H4a8 8 0 0 0 7 7.93z"/>
        </svg>
      </button>
    </div>
    <p id="mic-label">„Çø„ÉÉ„Éó„Åó„Å¶Ë©±„Åô</p>
  </div>
</div>

<script>
const micBtn = document.getElementById('mic-btn');
const micLabel = document.getElementById('mic-label');
const statusText = document.getElementById('status-text');
const statusArea = document.getElementById('status-area');
const questionArea = document.getElementById('question-area');
const questionText = document.getElementById('question-text');
const answerArea = document.getElementById('answer-area');
const answerText = document.getElementById('answer-text');
const transcriptBox = document.getElementById('transcript-box');
const scoreBar = document.getElementById('score-bar');
const scoreDisplay = document.getElementById('score-display');
const apiKeyInput = document.getElementById('api-key-input');

let currentQuestion = null;
let currentAnswer = null;
let state = 'idle'; // idle, question, waitNext
let correct = 0;
let total = 0;
let recognition = null;
let isListening = false;

// Saved questions pool to avoid repeats
let usedQuestions = new Set();

function showFlash(emoji) {
  const el = document.createElement('div');
  el.className = 'result-flash';
  el.textContent = emoji;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

function setStatus(msg) {
  statusArea.style.display = 'flex';
  statusText.textContent = msg;
}

function showLoadingDots() {
  statusArea.style.display = 'flex';
  statusText.innerHTML = '<div class="loading-dots"><span>‚óè</span><span>‚óè</span><span>‚óè</span></div>';
}

function speak(text, onEnd) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ja-JP';
  utter.rate = 1.0;
  utter.pitch = 1.1;
  if (onEnd) utter.onend = onEnd;
  speechSynthesis.speak(utter);
}

async function fetchQuestion() {
  const apiKey = apiKeyInput.value.trim();
  if (!apiKey) {
    setStatus('API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return null;
  }

  showLoadingDots();
  questionArea.style.display = 'none';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 300,
        messages: [{
          role: 'user',
          content: `Â∞èÂ≠¶Áîü„É¨„Éô„É´„Å†„Åë„Å©Â§ß‰∫∫„ÇÇ„Å≤„Å£„Åã„Åã„Çä„ÇÑ„Åô„ÅÑÈù¢ÁôΩ„ÅÑ„ÇØ„Ç§„Ç∫„Çí1ÂïèÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅÆ„Åø„ÅßËøîÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàË™¨Êòé‰∏çË¶ÅÔºâÔºö
{"question":"ÂïèÈ°åÊñá","answer":"Á≠î„Åà","hint":"„Å≤„Å£„Åã„Åã„Çä„ÇÑ„Åô„ÅÑ„Éù„Ç§„É≥„Éà„ÇÑË£úË∂≥"}
ÂïèÈ°å„ÅØ„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥„Çí„Å§„Åë„Å¶„ÄÅË®ÄËëâÈÅä„Å≥„ÉªÂ∏∏Ë≠ò„ÅÆÁõ≤ÁÇπ„ÉªÂãòÈÅï„ÅÑ„Åó„ÇÑ„Åô„ÅÑ‰∫ãÂÆü„Å™„Å©„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
        }]
      })
    });

    const data = await response.json();
    if (!data.content || !data.content[0]) throw new Error('API error');
    
    const raw = data.content[0].text;
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('JSON parse error');
    
    const parsed = JSON.parse(jsonMatch[0]);
    return parsed;
  } catch (e) {
    console.error(e);
    setStatus('ÂïèÈ°å„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇAPI„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return null;
  }
}

function startListening(onResult) {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome(Android)„Çí„Åä‰Ωø„ÅÑ„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.interimResults = true;
  recognition.continuous = true;
  recognition.maxAlternatives = 3;

  // AndroidÁî®ÔºöÁÑ°Èü≥„Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÇíÂª∂Èï∑Ôºà8ÁßíÔºâ
  let silenceTimer = null;
  let lastTranscript = '';

  recognition.onstart = () => {
    isListening = true;
    micBtn.classList.add('listening');
    micLabel.textContent = 'ËÅû„ÅÑ„Å¶„ÅÑ„Åæ„Åô‚Ä¶';
    transcriptBox.style.display = 'block';
    transcriptBox.textContent = '‚Ä¶';
  };

  recognition.onresult = (e) => {
    let interim = '';
    let final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    transcriptBox.textContent = final || interim;

    if (silenceTimer) clearTimeout(silenceTimer);

    if (final) {
      lastTranscript = final.trim();
      silenceTimer = setTimeout(() => {
        if (lastTranscript) {
          onResult(lastTranscript);
          lastTranscript = '';
        }
      }, 1500);
    }
  };

  recognition.onerror = (e) => {
    console.error(e.error);
    if (e.error === 'no-speech') return;
    stopListening();
    setStatus('ËÅû„ÅçÂèñ„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
  };

  recognition.onend = () => {
    if (isListening) {
      try { recognition.start(); } catch(e) { stopListening(); }
    }
  };

  recognition.start();
}

function stopListening() {
  isListening = false;
  micBtn.classList.remove('listening');
  micLabel.textContent = '„Çø„ÉÉ„Éó„Åó„Å¶Ë©±„Åô';
  if (recognition) { try { recognition.stop(); } catch(e){} }
  if (typeof silenceTimer !== 'undefined' && silenceTimer) clearTimeout(silenceTimer);
}

function normalizeText(t) {
  return t.replace(/[„ÅÅ-„Çì]/g, c => String.fromCharCode(c.charCodeAt(0) + 0x60))
          .replace(/[„ÄÄ ]/g, '')
          .toLowerCase();
}

function checkAnswer(spoken, answer) {
  const s = normalizeText(spoken);
  const a = normalizeText(answer);
  // Check if answer keywords are in spoken text
  return s.includes(a) || a.includes(s) || 
         (a.length > 1 && s.includes(a.substring(0, Math.ceil(a.length * 0.7))));
}

async function handleIdle(spoken) {
  if (spoken.includes('ÂïèÈ°å') || spoken.includes('„ÇÇ„Çì„Å†„ÅÑ') || spoken.includes('Âá∫„Åó„Å¶') || spoken.includes('Âßã„ÇÅ') || spoken.includes('„Çπ„Çø„Éº„Éà')) {
    stopListening();
    const q = await fetchQuestion();
    if (!q) return;
    
    currentQuestion = q.question;
    currentAnswer = q.answer;
    total++;
    scoreBar.style.display = 'flex';
    scoreDisplay.textContent = `${correct} / ${total}`;
    
    questionArea.style.display = 'block';
    questionText.textContent = currentQuestion;
    answerArea.style.display = 'none';
    statusArea.style.display = 'none';
    
    state = 'question';
    speak(currentQuestion, () => {
      setStatus('Á≠î„Åà„ÇíÂ£∞„ÅßË®Ä„Å£„Å¶„Åø„Çà„ÅÜÔºÅ');
      statusArea.style.display = 'flex';
    });
  } else {
    setStatus('„ÄåÂïèÈ°åÂá∫„Åó„Å¶„Äç„Å®Ë®Ä„Å£„Å¶„Åø„Çà„ÅÜÔºÅ');
  }
}

function handleQuestion(spoken) {
  stopListening();
  
  if (checkAnswer(spoken, currentAnswer)) {
    correct++;
    scoreDisplay.textContent = `${correct} / ${total}`;
    showFlash('‚≠ï');
    answerArea.style.display = 'block';
    answerText.textContent = currentAnswer;
    state = 'waitNext';
    speak(`Ê≠£Ëß£„Åß„ÅôÔºÅ${currentAnswer}„Åß„Åô„Å≠ÔºÅÊ¨°„ÅÆÂïèÈ°å„ÅÑ„Åç„Åæ„Åô„ÅãÔºü`, () => {
      setStatus('„Äå„ÅÑ„Åç„Åæ„Åô„Äç„Åã„Äå„ÇÑ„ÇÅ„Çã„Äç„Å®Ë®Ä„Å£„Å¶„Åè„Å†„Åï„ÅÑ');
    });
  } else {
    showFlash('‚ùå');
    setStatus(`ÊÉú„Åó„ÅÑÔºÅÁ≠î„Åà„ÅØ„Äå${currentAnswer}„Äç„Åß„Åó„Åü„ÄÇÊ¨°„ÅÆÂïèÈ°å„ÅÑ„Åç„Åæ„Åô„ÅãÔºü`);
    answerArea.style.display = 'block';
    answerText.textContent = currentAnswer;
    state = 'waitNext';
    speak(`ÊÆãÂøµÔºÅÊ≠£Ëß£„ÅØ${currentAnswer}„Åß„Åó„Åü„ÄÇÊ¨°„ÅÆÂïèÈ°å„ÅÑ„Åç„Åæ„Åô„ÅãÔºü`, () => {
      setStatus('„Äå„ÅÑ„Åç„Åæ„Åô„Äç„Åã„Äå„ÇÑ„ÇÅ„Çã„Äç„Å®Ë®Ä„Å£„Å¶„Åè„Å†„Åï„ÅÑ');
    });
  }
}

async function handleWaitNext(spoken) {
  if (spoken.includes('„ÅÑ„Åç') || spoken.includes('„ÅØ„ÅÑ') || spoken.includes('Ê¨°') || spoken.includes('„ÅÜ„Çì') || spoken.includes('OK') || spoken.includes('ok')) {
    stopListening();
    state = 'idle';
    const q = await fetchQuestion();
    if (!q) return;
    
    currentQuestion = q.question;
    currentAnswer = q.answer;
    total++;
    scoreDisplay.textContent = `${correct} / ${total}`;
    
    questionText.textContent = currentQuestion;
    answerArea.style.display = 'none';
    statusArea.style.display = 'none';
    
    state = 'question';
    speak(currentQuestion, () => {
      setStatus('Á≠î„Åà„ÇíÂ£∞„ÅßË®Ä„Å£„Å¶„Åø„Çà„ÅÜÔºÅ');
      statusArea.style.display = 'flex';
    });
  } else if (spoken.includes('„ÇÑ„ÇÅ') || spoken.includes('ÁµÇ„Çè„Çä') || spoken.includes('„Çπ„Éà„ÉÉ„Éó')) {
    stopListening();
    state = 'idle';
    speak(`„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ${total}Âïè‰∏≠${correct}ÂïèÊ≠£Ëß£„Åß„Åó„ÅüÔºÅ`, () => {
      setStatus(`ÁµÇ‰∫ÜÔºÅ${total}Âïè‰∏≠${correct}ÂïèÊ≠£Ëß£„Åß„Åó„Åü üéâ`);
      questionArea.style.display = 'none';
    });
  } else {
    setStatus('„Äå„ÅÑ„Åç„Åæ„Åô„Äç„Åã„Äå„ÇÑ„ÇÅ„Çã„Äç„Å®Ë®Ä„Å£„Å¶„Åè„Å†„Åï„ÅÑ');
  }
}

micBtn.addEventListener('click', () => {
  if (isListening) {
    stopListening();
    return;
  }

  transcriptBox.style.display = 'none';
  transcriptBox.textContent = '';

  startListening((spoken) => {
    transcriptBox.textContent = spoken;
    
    if (state === 'idle') handleIdle(spoken);
    else if (state === 'question') handleQuestion(spoken);
    else if (state === 'waitNext') handleWaitNext(spoken);
  });
});

// Initial speech
window.addEventListener('load', () => {
  setTimeout(() => {
    setStatus('„Éû„Ç§„ÇØ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„ÄåÂïèÈ°åÂá∫„Åó„Å¶„Äç„Å®Ë®Ä„Å£„Å¶„Åø„Çà„ÅÜÔºÅ');
  }, 500);
});
</script>
</body>
</html>
