<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å£°ã§ãªããªãï¼</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=M+PLUS+Rounded+1c:wght@400;800&display=swap');
  :root {
    --bg: #0f0e17; --surface: #1a1828; --accent: #ff6b35;
    --accent2: #ffd700; --text: #fffffe; --muted: #a7a9be;
    --wrong: #e53170; --correct: #2cb67d;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg); color: var(--text);
    font-family: 'Zen Maru Gothic', sans-serif;
    min-height: 100vh; display: flex; flex-direction: column;
    align-items: center; padding: 16px; position: relative;
  }
  .blob { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.12; pointer-events: none; }
  .blob1 { width: 280px; height: 280px; background: var(--accent); top: -80px; left: -80px; }
  .blob2 { width: 220px; height: 220px; background: #7b2fff; bottom: -60px; right: -60px; }
  .container { width: 100%; max-width: 460px; position: relative; z-index: 1; padding-top: 12px; }
  h1 {
    font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 800; font-size: 1.6rem;
    text-align: center; margin-bottom: 4px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .subtitle { text-align: center; color: var(--muted); font-size: 0.8rem; margin-bottom: 20px; }
  .card {
    background: var(--surface); border-radius: 20px; padding: 22px 20px;
    border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 16px 50px rgba(0,0,0,0.4);
    margin-bottom: 14px;
  }
  #api-key-area { margin-bottom: 14px; }
  #api-key-area label { font-size: 0.78rem; color: var(--muted); display: block; margin-bottom: 5px; }
  #api-key-input {
    width: 100%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; padding: 9px 12px; color: var(--text); font-family: monospace;
    font-size: 0.82rem; outline: none;
  }
  #api-key-input:focus { border-color: var(--accent); }
  .hint-text { font-size: 0.72rem; color: var(--muted); margin-top: 5px; opacity: 0.7; }
  #score-bar {
    display: none; justify-content: space-between; align-items: center;
    padding: 7px 14px; background: rgba(255,255,255,0.04); border-radius: 10px;
    margin-bottom: 14px; font-size: 0.82rem;
  }
  #score-bar span { color: var(--muted); }
  #score-bar strong { color: var(--accent2); font-size: 1rem; }
  #status-area {
    text-align: center; min-height: 50px; display: flex;
    align-items: center; justify-content: center; flex-direction: column; gap: 6px;
  }
  #status-text { font-size: 0.88rem; color: var(--muted); line-height: 1.5; }
  #question-area { display: none; text-align: center; margin-bottom: 10px; }
  #question-label {
    font-size: 0.72rem; color: var(--accent); font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px;
  }
  #question-text { font-size: 1.15rem; font-weight: 700; line-height: 1.6; color: var(--text); min-height: 60px; }
  #hint-area {
    display: none; margin-top: 12px; padding: 12px 14px;
    background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.25);
    border-radius: 12px; text-align: center;
  }
  #hint-label { font-size: 0.68rem; color: var(--accent2); letter-spacing: 1px; margin-bottom: 5px; font-weight: 700; }
  #hint-text { font-size: 0.95rem; color: var(--text); line-height: 1.5; }
  #answer-area {
    display: none; margin-top: 12px; padding: 14px;
    background: rgba(255,255,255,0.04); border-radius: 12px; text-align: center;
  }
  #answer-label { font-size: 0.68rem; color: var(--muted); letter-spacing: 1px; margin-bottom: 5px; }
  #answer-text { font-size: 1.05rem; font-weight: 700; color: var(--accent2); }
  #explanation-text { font-size: 0.85rem; color: var(--muted); line-height: 1.5; margin-top: 8px; display: none; }
  #transcript-box {
    background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px 14px;
    margin-top: 12px; font-size: 0.88rem; color: var(--muted);
    text-align: center; display: none; border: 1px solid rgba(255,255,255,0.08);
  }
  #warning-box {
    display: none; background: rgba(229,49,112,0.15); border: 1px solid rgba(229,49,112,0.3);
    border-radius: 10px; padding: 10px 14px; margin-top: 12px;
    font-size: 0.8rem; color: #ff9bb5; text-align: center; line-height: 1.5;
  }
  .mic-wrapper { display: flex; flex-direction: column; align-items: center; margin-top: 18px; gap: 8px; }
  #mic-btn {
    width: 100%; max-width: 300px; height: 72px; border-radius: 36px; border: none;
    background: linear-gradient(135deg, var(--accent), #ff8c42);
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
    box-shadow: 0 8px 28px rgba(255,107,53,0.4);
    font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; font-weight: 700; color: white;
    user-select: none; -webkit-user-select: none; touch-action: none;
    transition: background 0.15s, transform 0.1s, box-shadow 0.1s;
  }
  #mic-btn.pressing {
    transform: scale(0.95);
    background: linear-gradient(135deg, var(--wrong), #ff6b9d);
    box-shadow: 0 8px 36px rgba(229,49,112,0.6);
  }
  #mic-btn svg { width: 26px; height: 26px; fill: white; flex-shrink: 0; }
  #mic-label { text-align: center; font-size: 0.73rem; color: var(--muted); }
  .result-flash {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 5rem; pointer-events: none; z-index: 100;
    animation: flashAnim 0.8s ease forwards;
  }
  @keyframes flashAnim {
    0% { opacity: 1; transform: scale(0.5); }
    50% { opacity: 1; transform: scale(1.2); }
    100% { opacity: 0; transform: scale(1.5); }
  }
  .loading-dots span {
    display: inline-block; animation: dotBounce 1.2s ease-in-out infinite;
    color: var(--accent); font-size: 1.4rem;
  }
  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes dotBounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-8px); }
  }
</style>
</head>
<body>
<div class="blob blob1"></div>
<div class="blob blob2"></div>
<div class="container">
  <h1>ğŸ¤ å£°ã§ãªããªãï¼</h1>
  <p class="subtitle">å¤§äººã‚‚ã²ã£ã‹ã‹ã‚‹ï¼ãªããªã&ã‚¯ã‚¤ã‚ºğŸ˜„</p>
  <div class="card">
    <div id="api-key-area">
      <label>Anthropic APIã‚­ãƒ¼</label>
      <input type="password" id="api-key-input" placeholder="sk-ant-..." />
      <p class="hint-text">â€»ã“ã®ãƒšãƒ¼ã‚¸å†…ã®ã¿ã§ä½¿ç”¨ã•ã‚Œã¾ã™</p>
    </div>
    <div id="score-bar">
      <span>æ­£è§£æ•°</span>
      <strong id="score-display">0 / 0</strong>
    </div>
    <div id="status-area">
      <p id="status-text">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãªãŒã‚‰ã€Œå•é¡Œå‡ºã—ã¦ã€ã¨è¨€ãŠã†ï¼</p>
    </div>
    <div id="question-area">
      <div id="question-label">Q U E S T I O N</div>
      <div id="question-text"></div>
      <div id="hint-area">
        <div id="hint-label">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</div>
        <div id="hint-text"></div>
      </div>
      <div id="answer-area">
        <div id="answer-label">ã“ãŸãˆ</div>
        <div id="answer-text"></div>
        <div id="explanation-text"></div>
      </div>
    </div>
    <div id="warning-box"></div>
    <div id="transcript-box"></div>
    <div class="mic-wrapper">
      <button id="mic-btn" type="button" inputmode="none">
        <svg viewBox="0 0 24 24"><path d="M12 1a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V5a4 4 0 0 1 4-4zm-1 18.93V22h2v-2.07A8 8 0 0 0 20 12h-2a6 6 0 0 1-12 0H4a8 8 0 0 0 7 7.93z"/></svg>
        <span id="btn-text">æŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘è©±ã™</span>
      </button>
      <p id="mic-label">ğŸ”´ æŠ¼ã—ãªãŒã‚‰è©±ã™ â†’ é›¢ã™ã¨èªè­˜</p>
    </div>
  </div>
</div>

<script>
// DOM
const micBtn = document.getElementById('mic-btn');
const btnText = document.getElementById('btn-text');
const statusText = document.getElementById('status-text');
const statusArea = document.getElementById('status-area');
const questionArea = document.getElementById('question-area');
const questionText = document.getElementById('question-text');
const hintArea = document.getElementById('hint-area');
const hintText = document.getElementById('hint-text');
const answerArea = document.getElementById('answer-area');
const answerText = document.getElementById('answer-text');
const explanationText = document.getElementById('explanation-text');
const transcriptBox = document.getElementById('transcript-box');
const scoreBar = document.getElementById('score-bar');
const scoreDisplay = document.getElementById('score-display');
const apiKeyInput = document.getElementById('api-key-input');
const warningBox = document.getElementById('warning-box');

// State
let state = 'idle';
let correct = 0;
let total = 0;
let currentAnswer = '';
let currentHint = '';
let currentExplanation = '';
let recognition = null;
let isListening = false;
let isPressing = false;
let lastTranscript = '';
let resultHandled = false;

// å‡ºé¡Œå±¥æ­´ã‚’localStorageã§æ°¸ç¶šåŒ–
const STORAGE_KEY = 'nazotoki_used_v1';
function loadUsed() {
  try { return new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')); }
  catch(e) { return new Set(); }
}
function saveUsed(set) {
  try {
    const arr = Array.from(set).slice(-100);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  } catch(e) {}
}
let usedQuestions = loadUsed();

// Utils
function showFlash(emoji) {
  const el = document.createElement('div');
  el.className = 'result-flash';
  el.textContent = emoji;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

function setStatus(msg) {
  statusArea.style.display = 'flex';
  statusText.textContent = msg;
}

function showLoading() {
  statusArea.style.display = 'flex';
  statusText.innerHTML = '<div class="loading-dots"><span>â—</span><span>â—</span><span>â—</span></div>';
}

function speak(text, onEnd) {
  try {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ja-JP'; u.rate = 1.0; u.pitch = 1.1;
    if (onEnd) u.onend = onEnd;
    window.speechSynthesis.speak(u);
  } catch(e) { if (onEnd) setTimeout(onEnd, 100); }
}

function resetQuestionUI() {
  hintArea.style.display = 'none';
  answerArea.style.display = 'none';
  explanationText.style.display = 'none';
  hintText.textContent = '';
  answerText.textContent = '';
  explanationText.textContent = '';
}

function setBtnIdle() {
  micBtn.classList.remove('pressing');
  btnText.textContent = 'æŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘è©±ã™';
}

// API
async function fetchQuestion() {
  const apiKey = apiKeyInput.value.trim();
  if (!apiKey) { setStatus('ã¾ãšAPIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return null; }
  showLoading();
  questionArea.style.display = 'none';
  resetQuestionUI();

  const usedList = Array.from(usedQuestions).slice(-50).join('ã€') || 'ãªã—';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 400,
        messages: [{
          role: 'user',
          content: `å­ä¾›ã‚‚å¤§äººã‚‚æ¥½ã—ã‚ã‚‹ãªããªããƒ»ã‚¯ã‚¤ã‚ºã‚’1å•ä½œã£ã¦ãã ã•ã„ã€‚

ã€å‡ºé¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¿…ãšãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‘
â‘ å®šç•ªãªããªãï¼ˆæ˜”ã‹ã‚‰æ—¥æœ¬ã§è¦ªã—ã¾ã‚Œã¦ã„ã‚‹ã‚‚ã®ã€ä¾‹ï¼šã€Œåˆ‡ã£ã¦ã‚‚åˆ‡ã‚Œãªã„ã‚‚ã®ã¯ï¼Ÿã€ã€Œé ­ã¯ç™½ã„ã®ã«ä½“ã¯é»’ã„ã‚‚ã®ã¯ï¼Ÿã€ï¼‰
â‘¡è¨€è‘‰éŠã³ï¼ˆå›æ–‡ã€é€†èª­ã¿ã€ãƒ€ã‚¸ãƒ£ãƒ¬ç³»ã€ä¾‹ï¼šã€Œé€†ã‹ã‚‰èª­ã‚€ã¨å‹•ç‰©ã«ãªã‚‹é£Ÿã¹ç‰©ã¯ï¼Ÿã€ï¼‰
â‘¢å¸¸è­˜ã²ã£ã‹ã‘ï¼ˆæ€ã„è¾¼ã¿ã‚’ã¤ãã€ä¾‹ï¼šã€Œ1å¹´ã§ä¸€ç•ªæ—¥ãŒé•·ã„æœˆã¯ï¼Ÿã€ï¼‰
â‘£çŸ¥è­˜ã‚¯ã‚¤ã‚ºï¼ˆå°å­¦æ ¡ãƒ¬ãƒ™ãƒ«ã®ç†ç§‘ãƒ»ç¤¾ä¼šã€ä¾‹ï¼šã€Œå¤ªé™½ãŒæ²ˆã‚€æ–¹è§’ã¯ï¼Ÿã€ï¼‰
â‘¤ç®—æ•°ã²ã£ã‹ã‘ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ã€ä¾‹ï¼šã€Œ10ã‹ã‚‰1ã‚’ä½•å›å¼•ã‘ã‚‹ï¼Ÿã€ï¼‰

ã€çµ¶å¯¾ç¦æ­¢ã®å‡ºé¡Œå½¢å¼ã€‘
ãƒ»ã€Œã€‡ã€‡ã¯ã€‡ã€‡ã§ã‚‚ã€œãªã€‡ã€‡ã¯ï¼Ÿã€ã¨ã„ã†å½¢å¼ï¼ˆã€ŒãƒãƒŠãƒŠã¯ãƒãƒŠãƒŠã§ã‚‚ã€œã€ãªã©ã€é€ èªã‚„ç„¡ç†ãªè¨€è‘‰éŠã³ã«ãªã‚Šã‚„ã™ã„ï¼‰
ãƒ»å­˜åœ¨ã—ãªã„è¨€è‘‰ãƒ»é€ èªã‚’ç­”ãˆã«ã™ã‚‹å•é¡Œ
ãƒ»ã€Œç§ã¯ã€œã§ã™ã€‚ç§ã¯ä½•ã§ã—ã‚‡ã†ï¼Ÿã€ã¨ã„ã†å½¢å¼
ãƒ»ãƒ«ãƒ¼ãƒ«æ¨æ¸¬å‹ï¼ˆã€Œã‚ã‚‹æ³•å‰‡ã§ã€œã€ã€Œã‚ã‚‹åº—ã§ã€œã„ãã‚‰ï¼Ÿã€ãªã©ï¼‰
ãƒ»æ•°å­—ãƒ»ä¾¡æ ¼ãƒ»æ–‡å­—æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ç™ºè¦‹å•é¡Œ
ãƒ»åœ°å›³ãƒ»å›³å½¢ãƒ»ç©ºé–“ã‚’ä½¿ã£ãŸå•é¡Œ
ãƒ»æ•°åˆ—å•é¡Œ
ãƒ»è¤‡æ•°æ¡ä»¶ã®è«–ç†ãƒ‘ã‚ºãƒ«
ãƒ»ç‰¹å®šã®å®Ÿåœ¨äººç‰©ãƒ»æœ€æ–°ã®å‡ºæ¥äº‹ã«é–¢ã™ã‚‹å•é¡Œ
ãƒ»æ—¥æœ¬ã®æ—¥å¸¸ç”Ÿæ´»ã¨è‘—ã—ãç•°ãªã‚‹çŠ¶æ³ï¼ˆå‡ºã‹ã‘ã‚‹ã¨ãã€Œã•ã‚ˆã†ãªã‚‰ã€ãªã©ï¼‰
ãƒ»æµ·å¤–ã®æ–‡åŒ–ãƒ»ç¿’æ…£ã‚’å‰æã«ã—ãŸå•é¡Œ
ãƒ»é•·ã„è§£èª¬ãŒå¿…è¦ãªå•é¡Œ
ãƒ»ç­”ãˆãŒè¤‡æ•°è€ƒãˆã‚‰ã‚Œã‚‹æ›–æ˜§ãªå•é¡Œ

ã€å‡ºé¡Œå‰ã®è‡ªå·±ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰ã€‘
å•é¡Œã‚’ä½œã£ãŸã‚‰å¿…ãšç¢ºèªï¼š
1. ç­”ãˆã¯å®Ÿåœ¨ã™ã‚‹æ—¥æœ¬èªã®å˜èªãƒ»è¨€è‘‰ã‹ï¼Ÿ
2. ç­”ãˆã‚’èã„ã¦ã€Œãªã‚‹ã»ã©ï¼ã€ã¨èª°ã‚‚ãŒç´å¾—ã§ãã‚‹ã‹ï¼Ÿ
3. è§£èª¬ã¯1ã€œ2æ–‡ã§æ˜å¿«ã«èª¬æ˜ã§ãã‚‹ã‹ï¼Ÿ
1ã¤ã§ã‚‚NOãªã‚‰ä½œã‚Šç›´ã™ã“ã¨ã€‚

ã€çµ¶å¯¾ã«å®ˆã‚‹å“è³ªåŸºæº–ã€‘
ãƒ»ç­”ãˆã‚’èã„ãŸã¨ãã€Œãªã‚‹ã»ã©ï¼ç¢ºã‹ã«ï¼ã€ã¨èª°ã‚‚ãŒå¿ƒã‹ã‚‰ç´å¾—ã§ãã‚‹ã“ã¨
ãƒ»ã€Œãˆã€ãã‚Œã¯ç„¡ç†ãŒã‚ã‚‹ã€ã€Œã“ã˜ã¤ã‘ã§ã¯ï¼Ÿã€ã¨æ„Ÿã˜ã‚‹å•é¡Œã¯çµ¶å¯¾NG
ãƒ»ç¾å®Ÿçš„ã«ã‚ã‚Šãˆãªã„çŠ¶æ³ã‚’å‰æã«ã—ãŸå•é¡Œã¯NGï¼ˆä¾‹ï¼šä¿¡å·å¾…ã¡ã‚’1æ™‚é–“ã™ã‚‹ãªã©ï¼‰
ãƒ»ç­”ãˆãŒä¸€ã¤ã«å®šã¾ã‚‹ã“ã¨ï¼ˆè¤‡æ•°ã®è§£é‡ˆãŒã§ãã‚‹å•é¡Œã¯NGï¼‰

ã€AIãŒè‹¦æ‰‹ãªãŸã‚çµ¶å¯¾ç¦æ­¢ã®å•é¡Œã‚¿ã‚¤ãƒ—ã€‘
ãƒ»ãƒ«ãƒ¼ãƒ«æ¨æ¸¬å‹ï¼ˆã€Œã‚ã‚‹æ³•å‰‡ã§ã€œã€ã€Œã‚ã‚‹åº—ã§ã€œã„ãã‚‰ï¼Ÿã€ãªã©ã€è‡ªåˆ†ã§ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦æ•´åˆæ€§ã‚’ä¿ã¦ãªã„ã‚‚ã®ï¼‰
ãƒ»æ•°å­—ãƒ»ä¾¡æ ¼ãƒ»æ–‡å­—æ•°ã‚’ä½¿ã£ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ç™ºè¦‹å•é¡Œ
ãƒ»åœ°å›³ãƒ»å›³å½¢ãƒ»ç©ºé–“ã‚’ä½¿ã£ãŸå•é¡Œï¼ˆãƒ†ã‚­ã‚¹ãƒˆã§æ­£ç¢ºã«è¡¨ç¾ã§ããªã„ãŸã‚ï¼‰
ãƒ»ã€Œæ¬¡ã®æ•°åˆ—ã®ç¶šãã¯ï¼Ÿã€ãªã©ã®æ•°åˆ—å•é¡Œï¼ˆæ­£ç¢ºãªæ³•å‰‡è¨­å®šãŒå›°é›£ï¼‰
ãƒ»è¤‡æ•°ã®æ¡ä»¶ã‚’çµ„ã¿åˆã‚ã›ãŸè«–ç†ãƒ‘ã‚ºãƒ«ï¼ˆã€ŒAã¯Bã‚ˆã‚ŠèƒŒãŒé«˜ãã€Cã¯Dã‚ˆã‚Šã€œã€ãªã©ã€æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãŒå›°é›£ï¼‰
ãƒ»ç‰¹å®šã®å®Ÿåœ¨äººç‰©ãƒ»æœ€æ–°ã®å‡ºæ¥äº‹ã«é–¢ã™ã‚‹å•é¡Œï¼ˆäº‹å®Ÿèª¤èªã®ãƒªã‚¹ã‚¯ï¼‰
ãƒ»è¨ˆç®—ãŒå¿…è¦ãªå•é¡Œï¼ˆæš—ç®—ã§è§£ã‘ãªã„è¤‡é›‘ãªã‚‚ã®ï¼‰
ãƒ»æ—¥æœ¬èªãƒ»æ—¥æœ¬ã®æ–‡åŒ–ãƒ»ç¿’æ…£ãƒ»å¸¸è­˜ã«åŸºã¥ã„ãŸå•é¡Œã®ã¿å‡ºé¡Œã™ã‚‹ã“ã¨
ãƒ»æ—¥æœ¬ã®æ—¥å¸¸ç”Ÿæ´»ã¨è‘—ã—ãç•°ãªã‚‹çŠ¶æ³ã¯NGï¼ˆä¾‹ï¼šå‡ºã‹ã‘ã‚‹ã¨ãã€Œã•ã‚ˆã†ãªã‚‰ã€ã¨è¨€ã†ãªã©ã€æ—¥æœ¬ã§ã¯ã€Œã„ã£ã¦ãã¾ã™ã€ãŒæ­£ã—ã„ï¼‰
ãƒ»æµ·å¤–ã®æ–‡åŒ–ãƒ»ç¿’æ…£ã‚’å‰æã«ã—ãŸå•é¡Œã¯NG
ãƒ»æ—¥æœ¬èªã®è¨€è‘‰éŠã³ã¯æ—¥æœ¬èªã¨ã—ã¦æ­£ç¢ºã§ã‚ã‚‹ã“ã¨
ãƒ»ã€Œç§ã¯ã€œã§ã™ã€‚ç§ã¯ä½•ã§ã—ã‚‡ã†ï¼Ÿã€ã¨ã„ã†å½¢å¼ã¯çµ¶å¯¾ç¦æ­¢
ãƒ»é•·ã„è§£èª¬ãŒå¿…è¦ãªå•é¡Œã¯ç¦æ­¢

ã€æ¨å¥¨ã™ã‚‹å•é¡Œã‚¿ã‚¤ãƒ—ã€‘
ãƒ»ã‚·ãƒ³ãƒ—ãƒ«ãªã²ã£ã‹ã‘ï¼ˆè¨€è‘‰ã®æ„å‘³ã®ç›²ç‚¹ã‚’ã¤ãï¼‰
ãƒ»æ˜”ã‹ã‚‰ã‚ã‚‹å®šç•ªãªããªãï¼ˆã€Œåˆ‡ã£ã¦ã‚‚åˆ‡ã‚Œãªã„ã‚‚ã®ã¯ï¼Ÿã€ãªã©ï¼‰
ãƒ»è¨€è‘‰éŠã³ãƒ»å›æ–‡ãƒ»ã—ã‚Šã¨ã‚Šç³»
ãƒ»å°å­¦æ ¡ã§ç¿’ã†çŸ¥è­˜ã‚’ä½¿ã£ãŸå¸¸è­˜ã²ã£ã‹ã‘
ãƒ»ã€Œã€‡ã€‡ã¯ä½•è‰²ï¼Ÿã€ã€Œã€‡ã€‡ã¯ä½•åŒ¹è¶³ãŒã‚ã‚‹ï¼Ÿã€ãªã©ã®çŸ¥è­˜å•é¡Œ

ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ç­”ï¼ˆèª¬æ˜ãƒ»ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ä¸è¦ï¼‰ï¼š
{"question":"å•é¡Œæ–‡","answer":"ç­”ãˆï¼ˆçŸ­ãï¼‰","hint":"ç­”ãˆã«è¿‘ã¥ããƒ’ãƒ³ãƒˆï¼ˆç­”ãˆè‡ªä½“ã¯å«ã‚ãªã„ã€1æ–‡ï¼‰","explanation":"ç­”ãˆã®ç¨®æ˜ã‹ã—ï¼ˆ1ã€œ2æ–‡ã€ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰"}

ã™ã§ã«å‡ºé¡Œã—ãŸå•é¡Œï¼ˆçµ¶å¯¾ã«é‡è¤‡ç¦æ­¢ï¼‰ï¼š${usedList}`
        }]
      })
    });
    const data = await res.json();
    if (!data.content?.[0]?.text) throw new Error('no content');
    const match = data.content[0].text.match(/\{[\s\S]*?\}/);
    if (!match) throw new Error('no json');
    const q = JSON.parse(match[0]);
    usedQuestions.add(q.question.substring(0, 20));
    saveUsed(usedQuestions);
    return q;
  } catch(e) {
    console.error(e);
    setStatus('å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    return null;
  }
}

// Speech
function startRecognition() {
  if (isListening) return;
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    warningBox.style.display = 'block';
    warningBox.textContent = 'âš ï¸ Android Chromeã‚’ãŠä½¿ã„ãã ã•ã„';
    return;
  }
  warningBox.style.display = 'none';
  lastTranscript = '';
  resultHandled = false;
  isPressing = true;

  micBtn.classList.add('pressing');
  btnText.textContent = 'è©±ã—ã¦ãã ã•ã„â€¦';
  transcriptBox.style.display = 'block';
  transcriptBox.textContent = 'ğŸ¤ èã„ã¦ã„ã¾ã™â€¦';

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'ja-JP';
  recognition.interimResults = true;
  recognition.continuous = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => { isListening = true; };

  recognition.onresult = (e) => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    if (interim) transcriptBox.textContent = interim;
    if (final && !resultHandled) {
      lastTranscript = final.trim();
      resultHandled = true;
      isPressing = false;
      isListening = false;
      micBtn.classList.remove('pressing');
      btnText.textContent = 'å‡¦ç†ä¸­â€¦';
      transcriptBox.textContent = `ã€Œ${lastTranscript}ã€`;
      try { recognition.stop(); } catch(e) {}
      handleSpoken(lastTranscript);
    }
  };

  recognition.onerror = (e) => {
    console.warn('SR error:', e.error);
    if (e.error === 'no-speech') return;
    isListening = false;
    setBtnIdle();
    setStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ãã ã•ã„ã€‚');
  };

  recognition.onend = () => {
    // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã„ã‚‹é–“ã§çµæœæœªå–å¾—ãªã‚‰å†èµ·å‹•
    if (isPressing && !resultHandled) {
      try { recognition.start(); return; } catch(e) {}
    }
    isListening = false;
    // finalãŒæ¥ãªã‹ã£ãŸå ´åˆï¼ˆãƒœã‚¿ãƒ³ã‚’é›¢ã—ãŸå¾Œï¼‰
    if (!resultHandled) {
      setBtnIdle();
      if (lastTranscript) {
        resultHandled = true;
        handleSpoken(lastTranscript);
      } else {
        transcriptBox.style.display = 'none';
        setStatus('èãå–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦è©±ã—ã¦ãã ã•ã„ã€‚');
      }
    }
  };

  recognition.start();
}

function stopRecognition() {
  isPressing = false;
  if (!resultHandled) {
    micBtn.classList.remove('pressing');
    btnText.textContent = 'å‡¦ç†ä¸­â€¦';
  }
  try { if (recognition) recognition.stop(); } catch(e) {}
}

// Text matching
function normalize(t) {
  return t.replace(/[\u3041-\u3096]/g, c => String.fromCharCode(c.charCodeAt(0) + 0x60))
          .replace(/[ã€€ ]/g, '').toLowerCase();
}

function checkAnswer(spoken, answer) {
  const s = normalize(spoken);
  const a = normalize(answer);
  return s.includes(a) || a.includes(s) ||
    (a.length > 1 && s.includes(a.substring(0, Math.ceil(a.length * 0.7))));
}

// Game logic
async function startQuestion(q, countScore) {
  currentAnswer = q.answer;
  currentHint = q.hint || '';
  currentExplanation = q.explanation || '';
  if (countScore) total++;
  scoreBar.style.display = 'flex';
  scoreDisplay.textContent = `${correct} / ${total}`;
  questionArea.style.display = 'block';
  questionText.textContent = q.question;
  resetQuestionUI();
  statusArea.style.display = 'flex';
  setStatus('ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãªãŒã‚‰ç­”ãˆã‚’è¨€ã£ã¦ã¿ã‚ˆã†ï¼\nï¼ˆã€Œãƒ’ãƒ³ãƒˆã€ã€Œé•ã†å•é¡Œã€ã€Œã‚ã‹ã‚Šã¾ã›ã‚“ã€ã‚‚ä½¿ãˆã‚‹ã‚ˆï¼‰');
  state = 'question';
  speak(q.question);
  setBtnIdle();
}

async function handleSpoken(spoken) {
  if (state === 'idle') {
    if (/å•é¡Œ|ã‚‚ã‚“ã ã„|å‡ºã—ã¦|å§‹ã‚|ã‚¹ã‚¿ãƒ¼ãƒˆ|é–‹å§‹/.test(spoken)) {
      const q = await fetchQuestion();
      if (!q) return;
      await startQuestion(q, true);
    } else {
      setBtnIdle();
      setStatus('ã€Œå•é¡Œå‡ºã—ã¦ã€ã¨è¨€ã£ã¦ã¿ã‚ˆã†ï¼');
    }

  } else if (state === 'question') {
    if (/é•ã†å•é¡Œ|åˆ¥ã®å•é¡Œ|ã‚¹ã‚­ãƒƒãƒ—|é•ã†å•é¡Œ/.test(spoken)) {
      // ã‚¹ã‚­ãƒƒãƒ—ï¼šã‚«ã‚¦ãƒ³ãƒˆãªã—
      const q = await fetchQuestion();
      if (!q) return;
      await startQuestion(q, false);

    } else if (/ãƒ’ãƒ³ãƒˆ|ã²ã‚“ã¨/.test(spoken)) {
      setBtnIdle();
      if (currentHint) {
        hintArea.style.display = 'block';
        hintText.textContent = currentHint;
        speak(`ãƒ’ãƒ³ãƒˆã§ã™ã€‚${currentHint}`);
      } else {
        speak('ãƒ’ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ï¼');
      }

    } else if (/ã‚ã‹ã‚Šã¾ã›ã‚“|ã‚ã‹ã‚‰ãªã„|åˆ†ã‹ã‚Šã¾ã›ã‚“|åˆ†ã‹ã‚‰ãªã„|ã‚®ãƒ–|ã‚®ãƒ–ã‚¢ãƒƒãƒ—/.test(spoken)) {
      showFlash('ğŸ¤”');
      hintArea.style.display = 'none';
      answerArea.style.display = 'block';
      answerText.textContent = currentAnswer;
      if (currentExplanation) {
        explanationText.style.display = 'block';
        explanationText.textContent = `ğŸ’¡ ${currentExplanation}`;
      }
      state = 'waitNext';
      const msg = `æ­£è§£ã¯${currentAnswer}ã§ã—ãŸï¼${currentExplanation ? currentExplanation : ''}æ¬¡ã®å•é¡Œã«è¡Œãã¾ã™ã‹ï¼Ÿ`;
      speak(msg, () => setStatus('ã€Œã¯ã„ã€ã‹ã€Œã‚„ã‚ã‚‹ã€ã¨è¨€ã£ã¦ãã ã•ã„'));
      setBtnIdle();

    } else if (checkAnswer(spoken, currentAnswer)) {
      correct++;
      scoreDisplay.textContent = `${correct} / ${total}`;
      showFlash('â­•');
      hintArea.style.display = 'none';
      answerArea.style.display = 'block';
      answerText.textContent = currentAnswer;
      if (currentExplanation) {
        explanationText.style.display = 'block';
        explanationText.textContent = `ğŸ’¡ ${currentExplanation}`;
      }
      state = 'waitNext';
      const msg = `æ­£è§£ï¼${currentAnswer}ã§ã™ã­ï¼${currentExplanation ? currentExplanation : ''}æ¬¡ã®å•é¡Œã«è¡Œãã¾ã™ã‹ï¼Ÿ`;
      speak(msg, () => setStatus('ã€Œã¯ã„ã€ã‹ã€Œã‚„ã‚ã‚‹ã€ã¨è¨€ã£ã¦ãã ã•ã„'));
      setBtnIdle();

    } else {
      showFlash('âŒ');
      setBtnIdle();
      setStatus('æƒœã—ã„ï¼ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ï¼\nï¼ˆã€Œãƒ’ãƒ³ãƒˆã€ã§ãƒ’ãƒ³ãƒˆã€ã€Œã‚ã‹ã‚Šã¾ã›ã‚“ã€ã§æ­£è§£è¡¨ç¤ºï¼‰');
      speak('æƒœã—ã„ï¼ã‚‚ã†ä¸€åº¦ï¼');
    }

  } else if (state === 'waitNext') {
    if (/ã¯ã„|æ¬¡|ã†ã‚“|ok|OK|ç¶šã‘|ã‚‚ã£ã¨|ã„ã„|è‰¯ã„|è¡Œã|ã„ã/.test(spoken)) {
      const q = await fetchQuestion();
      if (!q) return;
      await startQuestion(q, true);

    } else if (/ã‚„ã‚|æ­¢ã‚|çµ‚ã‚ã‚Š|çµ‚ã‚ã‚‹|ã‚¹ãƒˆãƒƒãƒ—|ãŠã‚ã‚Š|ãŠã—ã¾ã„/.test(spoken)) {
      state = 'idle';
      questionArea.style.display = 'none';
      speak(`ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼${total}å•ä¸­${correct}å•æ­£è§£ã§ã—ãŸï¼`, () => {
        setStatus(`çµ‚äº†ï¼${total}å•ä¸­${correct}å•æ­£è§£ ğŸ‰`);
      });
      setBtnIdle();

    } else {
      setBtnIdle();
      setStatus('ã€Œã¯ã„ã€ã‹ã€Œã‚„ã‚ã‚‹ã€ã¨è¨€ã£ã¦ãã ã•ã„');
    }
  }
}

// Touch events
micBtn.addEventListener('touchstart', (e) => {
  e.preventDefault();
  if (document.activeElement) document.activeElement.blur();
  startRecognition();
}, { passive: false });

micBtn.addEventListener('touchend', (e) => {
  e.preventDefault();
  stopRecognition();
}, { passive: false });

micBtn.addEventListener('touchcancel', (e) => {
  e.preventDefault();
  stopRecognition();
}, { passive: false });

// Mouse events (PC)
micBtn.addEventListener('mousedown', () => startRecognition());
micBtn.addEventListener('mouseup', () => stopRecognition());
micBtn.addEventListener('mouseleave', () => { if (isListening) stopRecognition(); });
</script>
</body>
</html>
