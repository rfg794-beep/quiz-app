<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Â£∞„Åß„ÇØ„Ç§„Ç∫ÔºÅ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=M+PLUS+Rounded+1c:wght@400;800&display=swap');
  :root {
    --bg: #0f0e17; --surface: #1a1828; --accent: #ff6b35;
    --accent2: #ffd700; --text: #fffffe; --muted: #a7a9be;
    --wrong: #e53170;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg); color: var(--text);
    font-family: 'Zen Maru Gothic', sans-serif;
    min-height: 100vh; display: flex; flex-direction: column;
    align-items: center; padding: 16px; position: relative;
  }
  .blob { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.12; pointer-events: none; }
  .blob1 { width: 280px; height: 280px; background: var(--accent); top: -80px; left: -80px; }
  .blob2 { width: 220px; height: 220px; background: #7b2fff; bottom: -60px; right: -60px; }
  .container { width: 100%; max-width: 460px; position: relative; z-index: 1; padding-top: 12px; }
  h1 {
    font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 800; font-size: 1.6rem;
    text-align: center; margin-bottom: 4px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .subtitle { text-align: center; color: var(--muted); font-size: 0.8rem; margin-bottom: 20px; }
  .card {
    background: var(--surface); border-radius: 20px; padding: 22px 20px;
    border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 16px 50px rgba(0,0,0,0.4);
    margin-bottom: 14px;
  }
  #api-key-area { margin-bottom: 14px; }
  #api-key-area label { font-size: 0.78rem; color: var(--muted); display: block; margin-bottom: 5px; }
  #api-key-input {
    width: 100%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; padding: 9px 12px; color: var(--text); font-family: monospace;
    font-size: 0.82rem; outline: none;
  }
  #api-key-input:focus { border-color: var(--accent); }
  .hint { font-size: 0.72rem; color: var(--muted); margin-top: 5px; opacity: 0.7; }
  #score-bar {
    display: none; justify-content: space-between; align-items: center;
    padding: 7px 14px; background: rgba(255,255,255,0.04); border-radius: 10px;
    margin-bottom: 14px; font-size: 0.82rem;
  }
  #score-bar span { color: var(--muted); }
  #score-bar strong { color: var(--accent2); font-size: 1rem; }
  #status-area {
    text-align: center; min-height: 50px; display: flex;
    align-items: center; justify-content: center; flex-direction: column; gap: 6px;
  }
  #status-text { font-size: 0.88rem; color: var(--muted); line-height: 1.5; }
  #question-area { display: none; text-align: center; }
  #question-label {
    font-size: 0.72rem; color: var(--accent); font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px;
  }
  #question-text { font-size: 1.15rem; font-weight: 700; line-height: 1.6; color: var(--text); min-height: 70px; }
  #answer-area {
    display: none; margin-top: 16px; padding: 14px;
    background: rgba(255,255,255,0.04); border-radius: 12px; text-align: center;
  }
  #answer-label { font-size: 0.68rem; color: var(--muted); letter-spacing: 1px; margin-bottom: 5px; }
  #answer-text { font-size: 1.05rem; font-weight: 700; color: var(--accent2); }
  .mic-wrapper { display: flex; flex-direction: column; align-items: center; margin-top: 20px; gap: 10px; }
  #mic-btn {
    width: 100%; max-width: 300px; height: 76px; border-radius: 38px; border: none;
    background: linear-gradient(135deg, var(--accent), #ff8c42);
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
    box-shadow: 0 8px 28px rgba(255,107,53,0.4);
    font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; font-weight: 700; color: white;
    user-select: none; -webkit-user-select: none; touch-action: none;
    transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
  }
  #mic-btn.pressing {
    transform: scale(0.95);
    background: linear-gradient(135deg, var(--wrong), #ff6b9d);
    box-shadow: 0 8px 36px rgba(229,49,112,0.6);
  }
  #mic-btn svg { width: 28px; height: 28px; fill: white; flex-shrink: 0; }
  #mic-label { text-align: center; font-size: 0.75rem; color: var(--muted); }
  #transcript-box {
    background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px 14px;
    margin-top: 14px; font-size: 0.88rem; color: var(--muted); min-height: 38px;
    text-align: center; display: none; border: 1px solid rgba(255,255,255,0.08);
  }
  .result-flash {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 5rem; pointer-events: none; z-index: 100;
    animation: flashAnim 0.8s ease forwards;
  }
  @keyframes flashAnim {
    0% { opacity: 1; transform: scale(0.5); }
    50% { opacity: 1; transform: scale(1.2); }
    100% { opacity: 0; transform: scale(1.5); }
  }
  .loading-dots span {
    display: inline-block; animation: dotBounce 1.2s ease-in-out infinite;
    color: var(--accent); font-size: 1.4rem;
  }
  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes dotBounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-8px); }
  }
  #warning-box {
    display: none; background: rgba(229,49,112,0.15); border: 1px solid rgba(229,49,112,0.3);
    border-radius: 10px; padding: 10px 14px; margin-top: 12px;
    font-size: 0.8rem; color: #ff9bb5; text-align: center; line-height: 1.5;
  }
</style>
</head>
<body>
<div class="blob blob1"></div>
<div class="blob blob2"></div>
<div class="container">
  <h1>üé§ Â£∞„Åß„ÇØ„Ç§„Ç∫ÔºÅ</h1>
  <p class="subtitle">Â∞èÂ≠¶Áîü„É¨„Éô„É´„Å†„Åë„Å©Â§ß‰∫∫„ÇÇ„Å≤„Å£„Åã„Åã„Çã„ÇàüëÄ</p>
  <div class="card">
    <div id="api-key-area">
      <label>Anthropic API„Ç≠„Éº</label>
      <input type="password" id="api-key-input" placeholder="sk-ant-..." />
      <p class="hint">‚Äª„Åì„ÅÆ„Éö„Éº„Ç∏ÂÜÖ„ÅÆ„Åø„Åß‰ΩøÁî®„Åï„Çå„Åæ„Åô</p>
    </div>
    <div id="score-bar">
      <span>Ê≠£Ëß£Êï∞</span>
      <strong id="score-display">0 / 0</strong>
    </div>
    <div id="status-area">
      <p id="status-text">„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„ÅÑ„ÇãÈñì„Å†„ÅëË©±„Åó„Å¶„Å≠ÔºÅ</p>
    </div>
    <div id="question-area">
      <div id="question-label">Q U E S T I O N</div>
      <div id="question-text"></div>
      <div id="answer-area">
        <div id="answer-label">„Åì„Åü„Åà</div>
        <div id="answer-text"></div>
      </div>
    </div>
    <div id="warning-box"></div>
    <div id="transcript-box"></div>
    <div class="mic-wrapper">
      <button id="mic-btn" type="button" inputmode="none">
        <svg viewBox="0 0 24 24"><path d="M12 1a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V5a4 4 0 0 1 4-4zm-1 18.93V22h2v-2.07A8 8 0 0 0 20 12h-2a6 6 0 0 1-12 0H4a8 8 0 0 0 7 7.93z"/></svg>
        <span id="btn-text">Êäº„Åó„Å¶„ÅÑ„ÇãÈñì„Å†„ÅëË©±„Åô</span>
      </button>
      <p id="mic-label">üî¥ Êäº„Åó„Å™„Åå„ÇâË©±„Åô ‚Üí Èõ¢„Åô„Å®Ë™çË≠ò</p>
    </div>
  </div>
</div>
<script>
const micBtn = document.getElementById('mic-btn');
const btnText = document.getElementById('btn-text');
const statusText = document.getElementById('status-text');
const statusArea = document.getElementById('status-area');
const questionArea = document.getElementById('question-area');
const questionText = document.getElementById('question-text');
const answerArea = document.getElementById('answer-area');
const answerText = document.getElementById('answer-text');
const transcriptBox = document.getElementById('transcript-box');
const scoreBar = document.getElementById('score-bar');
const scoreDisplay = document.getElementById('score-display');
const apiKeyInput = document.getElementById('api-key-input');
const warningBox = document.getElementById('warning-box');

let currentAnswer = null;
let state = 'idle';
let correct = 0;
let total = 0;
let recognition = null;
let isListening = false;
let lastTranscript = '';
let resultHandled = false;

function showFlash(emoji) {
  const el = document.createElement('div');
  el.className = 'result-flash';
  el.textContent = emoji;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

function setStatus(msg) {
  statusArea.style.display = 'flex';
  statusText.textContent = msg;
}

function showLoadingDots() {
  statusArea.style.display = 'flex';
  statusText.innerHTML = '<div class="loading-dots"><span>‚óè</span><span>‚óè</span><span>‚óè</span></div>';
}

function speak(text, onEnd) {
  try {
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ja-JP'; utter.rate = 1.0; utter.pitch = 1.1;
    if (onEnd) utter.onend = onEnd;
    window.speechSynthesis.speak(utter);
  } catch(e) { if (onEnd) onEnd(); }
}

async function fetchQuestion() {
  const apiKey = apiKeyInput.value.trim();
  if (!apiKey) { setStatus('„Åæ„ÅöAPI„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return null; }
  showLoadingDots();
  questionArea.style.display = 'none';
  answerArea.style.display = 'none';
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 300,
        messages: [{ role: 'user', content: `Â∞èÂ≠¶Áîü„É¨„Éô„É´„Å†„Åë„Å©Â§ß‰∫∫„ÇÇ„Å≤„Å£„Åã„Åã„Çä„ÇÑ„Åô„ÅÑÈù¢ÁôΩ„ÅÑ„ÇØ„Ç§„Ç∫„Çí1Âïè‰Ωú„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË®ÄËëâÈÅä„Å≥„ÉªÂ∏∏Ë≠ò„ÅÆÁõ≤ÁÇπ„Éª„Å™„Åû„Å™„Åû„Å™„Å©‰Ωï„Åß„ÇÇOK„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅÆ„Åø„ÅßËøîÁ≠îÔºàË™¨Êòé‰∏çË¶ÅÔºâÔºö{"question":"ÂïèÈ°åÊñá","answer":"Á≠î„ÅàÔºàÁü≠„ÅèÔºâ"}` }]
      })
    });
    const data = await res.json();
    if (!data.content?.[0]?.text) throw new Error('API error');
    const match = data.content[0].text.match(/\{[\s\S]*?\}/);
    if (!match) throw new Error('parse error');
    return JSON.parse(match[0]);
  } catch(e) {
    console.error(e);
    setStatus('ÂïèÈ°å„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇAPI„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return null;
  }
}

function startRecognition() {
  if (isListening) return;
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    warningBox.style.display = 'block';
    warningBox.textContent = '‚ö†Ô∏è „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇAndroid Chrome„Çí„Åä‰Ωø„ÅÑ„Åè„Å†„Åï„ÅÑ„ÄÇ';
    return;
  }
  warningBox.style.display = 'none';
  lastTranscript = '';
  resultHandled = false;
  transcriptBox.style.display = 'block';
  transcriptBox.textContent = 'üé§ ËÅû„ÅÑ„Å¶„ÅÑ„Åæ„Åô‚Ä¶';
  micBtn.classList.add('pressing');
  btnText.textContent = 'Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶';

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'ja-JP';
  recognition.interimResults = true;
  recognition.continuous = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => { isListening = true; };

  recognition.onresult = (e) => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    const display = final || interim;
    transcriptBox.textContent = display || 'üé§ ËÅû„ÅÑ„Å¶„ÅÑ„Åæ„Åô‚Ä¶';
    if (final) lastTranscript += final;
    else if (interim) lastTranscript = interim; // interim„ÇÇ‰∏ÄÊôÇ‰øùÂ≠ò
  };

  recognition.onerror = (e) => {
    if (e.error === 'no-speech') return;
    console.warn('error:', e.error);
    isListening = false;
  };

  recognition.onend = () => {
    isListening = false;
    const spoken = lastTranscript.trim();
    micBtn.classList.remove('pressing');
    btnText.textContent = 'Êäº„Åó„Å¶„ÅÑ„ÇãÈñì„Å†„ÅëË©±„Åô';
    if (spoken && !resultHandled) {
      resultHandled = true;
      transcriptBox.textContent = `„Äå${spoken}„Äç`;
      handleSpoken(spoken);
    } else if (!spoken && !resultHandled) {
      transcriptBox.style.display = 'none';
      setStatus('ËÅû„ÅçÂèñ„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäº„Åó„Å¶Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
  };

  recognition.start();
}

function stopRecognition() {
  // recognition„ÇíÊ≠¢„ÇÅ„Å¶„ÄÅonend„ÅßÁµêÊûú„ÇíÂá¶ÁêÜ„Åô„Çã
  micBtn.classList.remove('pressing');
  btnText.textContent = 'Âá¶ÁêÜ‰∏≠‚Ä¶';
  isListening = false;
  if (recognition) {
    try { recognition.stop(); } catch(e) {}
  }
}

function normalizeText(t) {
  return t.replace(/[\u3041-\u3096]/g, c => String.fromCharCode(c.charCodeAt(0) + 0x60))
          .replace(/[„ÄÄ ]/g, '').toLowerCase();
}

function checkAnswer(spoken, answer) {
  const s = normalizeText(spoken);
  const a = normalizeText(answer);
  return s.includes(a) || a.includes(s) ||
    (a.length > 1 && s.includes(a.substring(0, Math.ceil(a.length * 0.7))));
}

async function handleSpoken(spoken) {
  if (state === 'idle') {
    if (/ÂïèÈ°å|„ÇÇ„Çì„Å†„ÅÑ|Âá∫„Åó„Å¶|Âßã„ÇÅ|„Çπ„Çø„Éº„Éà|ÈñãÂßã/.test(spoken)) {
      const q = await fetchQuestion();
      if (!q) return;
      currentAnswer = q.answer;
      total++;
      scoreBar.style.display = 'flex';
      scoreDisplay.textContent = `${correct} / ${total}`;
      questionArea.style.display = 'block';
      questionText.textContent = q.question;
      answerArea.style.display = 'none';
      statusArea.style.display = 'none';
      state = 'question';
      speak(q.question, () => setStatus('„Éú„Çø„É≥„ÇíÊäº„Åó„Å™„Åå„ÇâÁ≠î„Åà„ÇíË®Ä„Å£„Å¶„Åø„Çà„ÅÜÔºÅ'));
    } else {
      setStatus('„ÄåÂïèÈ°åÂá∫„Åó„Å¶„Äç„Å®Ë®Ä„Å£„Å¶„Åø„Çà„ÅÜÔºÅ');
    }
  } else if (state === 'question') {
    if (checkAnswer(spoken, currentAnswer)) {
      correct++;
      scoreDisplay.textContent = `${correct} / ${total}`;
      showFlash('‚≠ï');
      answerArea.style.display = 'block';
      answerText.textContent = currentAnswer;
      state = 'waitNext';
      speak(`Ê≠£Ëß£ÔºÅ${currentAnswer}„Åß„Åô„Å≠ÔºÅÊ¨°„ÅÆÂïèÈ°å„ÅÑ„Åç„Åæ„Åô„ÅãÔºü`, () => setStatus('„Äå„ÅÑ„Åç„Åæ„Åô„Äç„Åã„Äå„ÇÑ„ÇÅ„Çã„Äç„Å®Ë®Ä„Å£„Å¶„Åè„Å†„Åï„ÅÑ'));
    } else {
      showFlash('‚ùå');
      answerArea.style.display = 'block';
      answerText.textContent = currentAnswer;
      state = 'waitNext';
      speak(`ÊÆãÂøµÔºÅÊ≠£Ëß£„ÅØ${currentAnswer}„Åß„Åó„Åü„ÄÇÊ¨°„ÅÆÂïèÈ°å„ÅÑ„Åç„Åæ„Åô„ÅãÔºü`, () => setStatus('„Äå„ÅÑ„Åç„Åæ„Åô„Äç„Åã„Äå„ÇÑ„ÇÅ„Çã„Äç„Å®Ë®Ä„Å£„Å¶„Åè„Å†„Åï„ÅÑ'));
    }
  } else if (state === 'waitNext') {
    if (/„ÅÑ„Åç|„ÅØ„ÅÑ|Ê¨°|„ÅÜ„Çì|ok|Á∂ö„Åë|„ÇÇ„Å£„Å®/.test(spoken)) {
      const q = await fetchQuestion();
      if (!q) return;
      currentAnswer = q.answer;
      total++;
      scoreDisplay.textContent = `${correct} / ${total}`;
      questionText.textContent = q.question;
      answerArea.style.display = 'none';
      statusArea.style.display = 'none';
      state = 'question';
      speak(q.question, () => setStatus('„Éú„Çø„É≥„ÇíÊäº„Åó„Å™„Åå„ÇâÁ≠î„Åà„ÇíË®Ä„Å£„Å¶„Åø„Çà„ÅÜÔºÅ'));
    } else if (/„ÇÑ„ÇÅ|ÁµÇ„Çè„Çä|„Çπ„Éà„ÉÉ„Éó|„Åä„Çè„Çä|„Åä„Åó„Åæ„ÅÑ/.test(spoken)) {
      state = 'idle';
      speak(`„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ${total}Âïè‰∏≠${correct}ÂïèÊ≠£Ëß£„Åß„Åó„ÅüÔºÅ`, () => {
        setStatus(`ÁµÇ‰∫ÜÔºÅ${total}Âïè‰∏≠${correct}ÂïèÊ≠£Ëß£ üéâ`);
        questionArea.style.display = 'none';
      });
    } else {
      setStatus('„Äå„ÅÑ„Åç„Åæ„Åô„Äç„Åã„Äå„ÇÑ„ÇÅ„Çã„Äç„Å®Ë®Ä„Å£„Å¶„Åè„Å†„Åï„ÅÑ');
    }
  }
}

// „Çø„ÉÉ„ÉÅÊìç‰ΩúÔºà„Çπ„Éû„ÉõÔºâ
micBtn.addEventListener('touchstart', (e) => {
  e.preventDefault();
  // „Ç≠„Éº„Éú„Éº„Éâ„ÇíÈñâ„Åò„Çã
  if (document.activeElement) document.activeElement.blur();
  startRecognition();
}, { passive: false });
micBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecognition(); }, { passive: false });
micBtn.addEventListener('touchcancel', (e) => { e.preventDefault(); stopRecognition(); }, { passive: false });

// „Éû„Ç¶„ÇπÊìç‰ΩúÔºàPCÔºâ
micBtn.addEventListener('mousedown', () => startRecognition());
micBtn.addEventListener('mouseup', () => stopRecognition());
micBtn.addEventListener('mouseleave', () => { if (isListening) stopRecognition(); });
</script>
</body>
</html>
